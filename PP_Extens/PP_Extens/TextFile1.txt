Option Base 1
Option Explicit
Option Compare Text
'
'


Private Sub UtilLigacaoCBL_AntesDeProcessarCBL(Cancel As Boolean)
    
    Const Erro = 0.02
    
    Dim objcbl As CblBEDocumento
    Dim Tipodoc As String
    Dim diff As Double
    Dim totaldeb As Double
    Dim totalcred As Double
    Dim totalivadeb As Double
    Dim totalivacred As Double
    Dim totaldocorig As Double
    Dim totalivadocorig As Double
    Dim i As Integer
    Dim l As Integer
    
    Tipodoc = Me.DocumentoCBL.doc
    
    If Me.DocumentoCBL.Modulo = "C" Then
        
        If ((Tipodoc = "VFA") Or (Tipodoc = "VFS")) And (Me.DocumentoCBL.LinhasGeral.NumItens <> 0) Then
            
            totaldeb = 0
            totalcred = 0
            totalivadeb = 0
            totalivacred = 0
            totaldocorig = BSO.Comercial.Compras.DaTotalDocumento(Me.DocumentoCBL.IdDocOrigem)
            totalivadocorig = BSO.Comercial.Compras.DaValorAtributoid(Me.DocumentoCBL.IdDocOrigem, "TotalIVA")
            
            CalculaTotaisLancamento totaldeb, totalcred, totalivadeb, totalivacred
            
            If (totaldeb <> totalcred) And (Abs(totaldeb - totalcred) <= Erro) Then
                                                                                   
                For i = 1 To Me.DocumentoCBL.LinhasGeral.NumItens
                    
                    If Abs(Me.DocumentoCBL.LinhasGeral(i).Valor - totalcred) <= Erro Then
                        
                        If (Me.DocumentoCBL.LinhasGeral(i).Conta Like "221*") _
                            Or (Me.DocumentoCBL.LinhasGeral(i).Conta Like "1*") Then
                            
                            Me.DocumentoCBL.LinhasGeral(i).Valor = totaldocorig
                            Me.DocumentoCBL.LinhasGeral(i).ValorAlt = totaldocorig
                            Me.DocumentoCBL.LinhasGeral(i).ValorIncIVA = totaldocorig
                            Me.DocumentoCBL.LinhasGeral(i).ValorIncIVAAlt = totaldocorig
                            
                        End If
                        
                    End If
                    
                Next i
                
            End If
            
            CalculaTotaisLancamento totaldeb, totalcred, totalivadeb, totalivacred
            
            If (totaldeb <> totalcred) And (Abs(totalivadeb - totalivacred) <= Erro) And (Abs(totalivadocorig - totalivadeb) <= Erro) Then
                
            End If
            
            CalculaTotaisLancamento totaldeb, totalcred, totalivadeb, totalivacred
            
            If (totaldeb <> totalcred) And (Abs(totaldocorig + totalivadocorig - totaldeb + totalivadeb) <= Erro) Then
                
                l = 0
                diff = 0
                
                For i = 1 To Me.DocumentoCBL.LinhasGeral.NumItens
                    
                    If (Me.DocumentoCBL.LinhasGeral(i).Valor > diff) And (Me.DocumentoCBL.LinhasGeral(i).Conta Like "[3,6]*") Then
                        
                        diff = Me.DocumentoCBL.LinhasGeral(i).Valor
                        l = i
                        
                    End If
                    
                Next i
                
                If Me.DocumentoCBL.LinhasGeral(l).Natureza = "D" Then
                    
                    Me.DocumentoCBL.LinhasGeral(l).Valor = Me.DocumentoCBL.LinhasGeral(l).Valor - totaldeb + totalcred
                    
                ElseIf Me.DocumentoCBL.LinhasGeral(l).Natureza = "C" Then
                    
                    Me.DocumentoCBL.LinhasGeral(l).Valor = Me.DocumentoCBL.LinhasGeral(l).Valor + totaldeb - totalcred
                    
                Else
                    
                    MsgBox "Não pode chegar aqui.", vbOKOnly + vbCritical
                    
                End If
                
            End If
            
        End If
        
        CalculaTotaisLancamento totaldeb, totalcred, totalivadeb, totalivacred
        
        If (Abs(totaldeb - totalcred) > 0) And (Abs(totaldeb - totalcred) <= Erro) And _
            (Abs(BSO.Comercial.Compras.DaValorAtributo(Me.DocumentoCBL.doc, Me.DocumentoCBL.NumDoc, Me.DocumentoCBL.Serie, "000", "TotalIva")) - totalivadeb <> 0) Then
            
            diff = 0
            
            For i = 1 To Me.DocumentoCBL.LinhasGeral.NumItens
                
                If (Me.DocumentoCBL.LinhasGeral(i).Valor > diff) And (Me.DocumentoCBL.LinhasGeral(i).Conta Like "[243]*") Then
                    
                    diff = Me.DocumentoCBL.LinhasGeral(i).Valor
                    l = i
                    
                End If
                
            Next i
            
            Me.DocumentoCBL.LinhasGeral(i).Valor = Me.DocumentoCBL.LinhasGeral(i).Valor + (totalcred - totaldeb)
            
        End If
        
    ElseIf Me.DocumentoCBL.Modulo = "V" Then
        
        If ((Tipodoc = "FR") Or (Tipodoc = "FRH")) And (Me.DocumentoCBL.LinhasGeral.NumItens <> 0) Then
            
            totaldeb = 0
            totalcred = 0
            totalivadeb = 0
            totalivacred = 0
            totaldocorig = BSO.Comercial.Vendas.DaTotalDocumento(Me.DocumentoCBL.IdDocOrigem)
            
            CalculaTotaisLancamento totaldeb, totalcred, totalivadeb, totalivacred
            
            If (totaldeb <> totalcred) And (Abs(totaldeb - totalcred) <= Erro) Then
                                                                                   
                For i = 1 To Me.DocumentoCBL.LinhasGeral.NumItens
                    
                    If Abs(Me.DocumentoCBL.LinhasGeral(i).Valor - totaldocorig) <= Erro Then
                        
                        If (Me.DocumentoCBL.LinhasGeral(i).Conta Like "21*") _
                            Or (Me.DocumentoCBL.LinhasGeral(i).Conta Like "1*") Then
                            
                            Me.DocumentoCBL.LinhasGeral(i).Valor = totaldocorig
                            Me.DocumentoCBL.LinhasGeral(i).ValorAlt = totaldocorig
                            
                        End If
                        
                    End If
                    
                Next i
                
            End If
            
        End If
        
    End If
    
End Sub
'
'


Private Sub CalculaTotaisLancamento(ByRef totaldeb, totalcred, totalivadeb, totalivacred As Double)
    
    Dim i As Integer
    
    totaldeb = 0
    totalcred = 0
    totalivadeb = 0
    totalivacred = 0
    
    For i = 1 To Me.DocumentoCBL.LinhasGeral.NumItens
        
        If Me.DocumentoCBL.LinhasGeral(i).Natureza = "D" Then
            
            totaldeb = totaldeb + Me.DocumentoCBL.LinhasGeral(i).Valor
            
            If Me.DocumentoCBL.LinhasGeral(i).Conta Like "243*" Then
                
                totalivadeb = totalivadeb + Me.DocumentoCBL.LinhasGeral(i).Valor
                
            End If
            
        ElseIf Me.DocumentoCBL.LinhasGeral(i).Natureza = "C" Then
            
            totalcred = totalcred + Me.DocumentoCBL.LinhasGeral(i).Valor
            
            If Me.DocumentoCBL.LinhasGeral(i).Conta Like "243*" Then
                
                totalivacred = totalivacred + Me.DocumentoCBL.LinhasGeral(i).Valor
                
            End If
            
        Else
            
        End If
        
    Next i
    
End Sub
'